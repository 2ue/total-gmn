# 导入、统计与分润计算逻辑说明

本文档描述当前系统在后端实际实现的业务口径，便于开发、联调与验算。

## 1. 数据导入逻辑

### 1.1 导入入口

- 文件导入：`POST /api/imports`
- 文本导入：`POST /api/imports/text`
- 手动逐条导入（支持截图）：`POST /api/imports/manual`

相关代码：

- `apps/api/src/routes/imports.ts`
- `apps/api/src/lib/parser.ts`
- `apps/api/src/lib/import-service.ts`

### 1.2 解析规则

系统支持两类主要输入：

1. 支付宝原始导出 CSV（带“导出信息”与完整表头）
2. 简化 CSV / 文本（至少能识别 `金额 + 备注`，或完整交易字段）

解析过程会自动做编码识别（`utf8` 与 `gb18030`），并归一化为统一结构：

- `billAccount`
- `transactionTime`
- `direction`（income/expense/neutral）
- `amount`（绝对值字符串）
- `status`
- `description`
- `orderId`
- `merchantOrderId`
- `remark`

### 1.3 交易分类与过滤

分类在 `packages/shared/src/rules.ts` 中实现，主流程：

1. 先按业务时间窗口过滤（`>= 2025-12-30 00:00:00 +08:00`）。
2. 再按描述/状态分类（主营、流量、平台抽成、交易关闭、退款等）。
3. 同订单去重并识别“同单一收一支”为内部互转。
4. 仅保留符合业务口径类别：
   - `main_business`
   - `manual_add`
   - `traffic_cost`
   - `platform_commission`
   - `business_refund_expense`
   - `internal_transfer`
   - `closed`

### 1.4 导入幂等与去重

导入入库前会构造 `dedupeKey`：

- 有订单号时：`order|billAccount|orderId|direction`
- 无订单号时使用回退键：`billAccount + time + direction + amount + status + description + remark`

如果数据库里已有相同 `dedupeKey`：

- 新记录时间更晚：覆盖旧记录关键字段
- 否则：跳过

这样可保证重复导入同一账单不会无限叠加。

### 1.5 特殊规则：待发货超期自动转成功

仅对 `alipay_csv` 且已通过业务筛选的记录生效：

- 状态为 `等待发货/待发货`
- 交易时间超过 10 天

导入时自动改为：

- `status = 交易成功`
- `direction = income`

> 目的是把长期未完结但已确认收款性质的主营记录纳入已到账口径。

### 1.6 手动导入规则

手动导入统一归类为 `manual_add`，并强制：

- 状态：`交易成功`
- 金额：取绝对值
- 方向：由前端/接口传入（income 或 expense）

每条手动记录会生成稳定 `orderId`（`MANUAL...`），便于去重和追踪。

---

## 2. 统计口径（报表页）

相关代码：`apps/api/src/lib/profit-report.ts`

### 2.1 主指标定义

- 主营已到账收入：`category in (main_business, manual_add)` 且 `direction=income` 且 `status=交易成功`
- 主营待到账收入：`category in (main_business, manual_add)` 且 `direction=income` 且 `status in 待确认/待发货/待付款...`
- 主营支出：`category in (main_business, manual_add)` 且 `direction=expense`
- 流量消耗：`category=traffic_cost`
- 平台抽成：`category=platform_commission`
- 主营关闭交易金额：`category=closed` 的金额总和（仅展示字段）
- 主营退款支出：`category=business_refund_expense`

> `internal_transfer=true` 的记录在统计时会被排除，不参与利润。

### 2.2 纯收益公式

纯收益（仅已到账）：

```text
mainSettledIncome
- mainExpense
- trafficCost
- platformCommission
+ closedNetContribution(可配置)
```

纯收益（含待到账）：

```text
mainSettledIncome
+ mainPendingIncome
- mainExpense
- trafficCost
- platformCommission
+ closedNetContribution(可配置)
```

其中：

```text
closedNetContribution = mainClosedIncome - mainClosedExpense
```

是否启用由环境变量控制（默认启用）。

---

## 3. 分润计算逻辑（累计/增量）

相关代码：`apps/api/src/lib/settlement.ts`

### 3.1 分润策略

- `cumulative`（累计）：按结算时点前的全量净额计算
- `incremental`（增量）：仅计算未被增量批次标记过的新记录

### 3.2 净额口径

分润净额使用与报表一致的核心结构：

```text
净额 = 已到账收入 - 主营支出 - 流量消耗 - 平台抽成 - 主营退款支出 + 关闭净额(可配置)
```

### 3.3 留存比例（carryRatio）

在每次分润预览/创建时可设置留存比例（0~1）：

- 可分润额 `P(T) = C(T) - S(T)`
- 当 `P(T) > 0`：
  - 本次实发 = `P(T) * (1 - 留存比例)`
  - 留存余额 = `P(T) * 留存比例`
- 当 `P(T) <= 0`：
  - 本次实发 = 0
  - 留存余额 = `|P(T)|`（作为负向结转）

### 3.4 分润者分配

分润者比例总和必须为 100%，每人本次应收/应支：

```text
amount_i = allocationBaseAmount * ratio_i
```

并做 2 位小数与末位差额校正，确保总和一致。

### 3.5 账号已收（估算）与实际应收/应付

系统会先按“绑定账号净额占比”算出各账号在本次基数中的已收份额，再映射到分润者：

```text
actualTransfer_i = amount_i - accountHeldAmount_i
```

用于得到“本次还需要给/收多少”。

---

## 4. 环境变量（均为实际生效）

示例文件：

- API：`apps/api/.env.example`
- Web：`apps/web/.env.example`

### 4.1 `DATABASE_URL`

- 用途：Prisma 数据源连接
- 读取位置：`apps/api/prisma/schema.prisma`

### 4.2 `PROFIT_INCLUDE_CLOSED_DIRECTION_IN_PROFIT`

- 用途：控制“交易关闭收入/支出”是否计入纯收益与分润净额
- 读取位置：`apps/api/src/lib/profit-mode.ts`
- 生效路径：
  - `apps/api/src/lib/profit-report.ts`
  - `apps/api/src/lib/settlement.ts`

### 4.3 `PORT` / `HOST`

- 用途：API 服务监听端口与地址
- 读取位置：`apps/api/src/server.ts`

### 4.4 `VITE_DEFAULT_SETTLEMENT_CARRY_PERCENT`

- 用途：分润页“留存比例”输入框默认值（百分比）
- 默认值：`30`
- 读取位置：`apps/web/src/App.tsx`
- 规则：仅允许 `0~100` 整数，非法值回退为 `30`

---

## 5. 说明

- 前端当前默认以“累计分润页”为主入口（增量策略仍保留后端能力）。
- 报表和分润的核心净额口径保持一致，避免两套口径导致对账偏差。
