## 背景

本系统的核心流程是：
1. 用户直接导入账单 CSV 文件（支付宝原始账单和简化账单）。
2. 系统解析文件并标准化交易数据。
3. 系统按“符合条件规则”筛选交易。
4. 符合条件数据入库（阶段1交付终点）。
5. 统计与分润（阶段2再启用，不阻塞阶段1上线）。

已确认统计口径：
- 仅统计 `2025-12-30 00:00:00` 及之后数据。
- 主营关键词（不区分大小写）：`codex|gemini|90刀|满血api|90d`，排除 `批量|批发`。
- `闲鱼转账` 计入主营交易。
- `闲鱼超级擦亮充值` 计入流量消耗。
- `分账-` 计入平台抽成。
- `交易关闭` 不计入总统计，但单独统计。
- 同订单号出现“一收一支”标记为内部互转并在总统计中抵消。
- 仅主营范围退款计入主营退款支出扣减，不依赖订单关联。

已确认分润口径（累计法）：
- 截止结算时点 `T`，先计算累计可分润净额 `C(T)`。
- `C(T) = 累计已到账收入 - 累计实际支出（主营支出 + 流量消耗 + 平台抽成 + 主营退款支出）`。
- 读取最近一次有效分润批次的累计已分润额 `S(T)`。
- 本次可分润额 `P(T) = C(T) - S(T)`。
- 若 `P(T) <= 0`，本次实发为 0，负值结转。

## 目标 / 非目标

**目标：**
- 阶段1先构建“导入-解析-筛选-入库-明细查询”的稳定闭环。
- 阶段2再补齐“统计-分润”能力。
- 支持支付宝 CSV 与简化 CSV 两类导入格式。

**非目标：**
- 不对接第三方支付平台实时 API（首版仅离线账单导入）。
- 不实现复杂权限体系（首版单用户本地账本）。
- 不做机器学习自动分类（首版规则驱动）。
- 不做规则版本追溯（本阶段明确不考虑）。

## 关键决策

- 阶段1仅要求“符合条件数据入库成功且可查”，统计聚合先不作为上线门槛。
- 阶段2统计与分润均只基于数据库结果，不使用前端临时数据。
- 处理顺序固定：
  - 时间过滤
  - 内部互转识别
  - 成本分类（流量消耗、平台抽成、主营退款支出）
  - 主营分类（关键词 + 闲鱼转账）
  - 状态分桶（已到账、待到账、关闭）
- 纯收益公式固定：
  - `纯收益(仅已到账) = 主营已到账收入 - 主营支出 - 流量消耗 - 平台抽成`
  - `纯收益(含待到账) = 主营已到账收入 + 主营待到账收入 - 主营支出 - 流量消耗 - 平台抽成`
- 分润公式固定：
  - `P(T) = C(T) - S(T)`。
  - `S(T)` 采用最近一次有效分润批次值，不要求累加全部历史批次。
- 分润批次允许删除重算，界面展示“当前有效批次”和历史记录。

## 脱离上下文执行指引

以下步骤可在无聊天上下文时直接执行：
1. 环境准备：`node>=20`、`pnpm>=9`、`sqlite3`。
2. 初始化工程：先完成 `tasks.md` 的 1.x 与 2.x。
3. 优先实现导入链路：按 `tasks.md` 的 3.x 与 4.x 完成解析、规则筛选、入库。
4. 验收阶段1：导入两份参考账单后，必须能在明细接口中查询到“符合条件交易”。
5. 统计与分润延后：阶段1通过后再执行 `tasks.md` 的 5.x、6.x、7.x（统计与分润相关任务）。

## 风险与取舍

- 风险：账单字段存在异常值或缺失。  
  - 取舍：入库保留原始行数据，未知状态不参与核心口径但可在明细查看。
- 风险：关键词漏判导致主营收入偏差。  
  - 取舍：保留规则配置能力，支持后续补词。
- 风险：同一订单状态变化（待确认 -> 成功/退款）导致重复统计。  
  - 取舍：以订单号做状态覆盖，统计按订单最新状态全量重算。
- 风险：缺少“有效批次”定义导致分润基准混乱。  
  - 取舍：始终以最近一次有效分润批次作为 `S(T)` 基准。
