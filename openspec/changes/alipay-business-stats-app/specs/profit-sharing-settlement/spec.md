## ADDED Requirements

### Requirement: 分润采用累计法计算
系统 SHALL 在每次结算时按全历史累计值计算本次可分润金额。

#### Scenario: 计算累计可分润净额
- **WHEN** 用户在结算时点 `T` 发起分润计算
- **THEN** 系统必须计算 `C(T)`：截止 `T` 的累计可分润净额
- **THEN** `C(T)` 必须等于 `累计已到账收入 - 累计实际支出（主营支出 + 流量消耗 + 平台抽成 + 主营退款支出）`

#### Scenario: 计算本次可分润金额
- **WHEN** 用户在结算时点 `T` 发起分润计算
- **THEN** 系统必须读取 `S(T)`：最近一次有效分润批次的累计已分润值
- **THEN** 系统必须计算 `P(T) = C(T) - S(T)` 作为本次可分润金额

### Requirement: 负值分润处理与结转
系统 SHALL 支持可分润金额为负时的自动结转逻辑。

#### Scenario: 可分润金额为负
- **WHEN** `P(T) < 0`
- **THEN** 系统必须将本次实发金额置为 `0`
- **THEN** 系统必须记录 `|P(T)|` 为待冲销结转余额

#### Scenario: 可分润金额为零
- **WHEN** `P(T) = 0`
- **THEN** 系统必须将本次实发金额置为 `0`
- **THEN** 系统必须记录结转余额为 `0`

### Requirement: 分润批次台账可追溯
系统 SHALL 为每次结算写入可审计批次记录。

#### Scenario: 记录批次快照
- **WHEN** 用户确认执行一次分润结算
- **THEN** 系统必须保存批次快照字段：`settlementTime, C(T), S(T), P(T), paidAmount, carryForwardAmount, note`
- **THEN** 系统必须为批次生成唯一编号并可在历史页面查询

### Requirement: 有效批次覆盖与删除重算
系统 SHALL 支持以最新有效批次为基准，并允许删除后重算。

#### Scenario: 最新批次成为有效基准
- **WHEN** 新结算批次创建成功
- **THEN** 系统必须将该批次标记为当前有效批次
- **THEN** 下次计算 `S(T)` 必须使用该有效批次值

#### Scenario: 删除有效批次后回退基准
- **WHEN** 用户删除当前有效批次
- **THEN** 系统必须回退到上一个可用批次作为有效基准
- **THEN** 重新计算时必须基于回退后的 `S(T)` 计算 `P(T)`
