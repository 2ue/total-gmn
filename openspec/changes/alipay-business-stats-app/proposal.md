## 背景与动机

当前只有原始支付宝账单 CSV，缺少统一口径的业务统计能力，无法稳定得到“已到账收益、待到账收益、关闭交易、成本项和纯收益”。现在需要把已确认的业务规则固化为系统能力，避免手工统计误差并支持后续扩展导入格式。

## 变更内容

- 采用两阶段交付：
  - 阶段1（本次必须完成）：只做“符合条件数据导入+入库”，并可在明细页查询已导入记录。
  - 阶段2（后续迭代）：完善统计聚合、分润结算和页面可视化。
- 阶段1新增账单导入与标准化能力，支持支付宝原始 CSV（含顶部账号信息）与简化格式（`金额,备注`）导入。
- 阶段1新增“解析后按规则筛选再入库”流程：仅将符合条件交易入库到业务交易表。
- 阶段1新增交易去重与内部互转标记能力：以`交易订单号`去重，同订单号出现“一收一支”时标记为内部互转（入库保留标记）。
- 阶段1固化规则引擎（大小写不敏感）：
  - 主营交易关键词：商品说明满足关键字`codex|gemini|90刀|满血api|90d`，且排除`批量|批发`。
  - 主营交易补充规则：`商品说明=闲鱼转账`纳入主营统计。
  - 流量消耗：`商品说明`包含`闲鱼超级擦亮充值`。
  - 平台抽成：`商品说明`包含`分账-`。
  - 统计时间范围：仅统计`2025-12-30 00:00:00`及之后交易。
- 阶段2补充收益与成本统计口径：
  - 总统计包含：主营已到账收入、主营待到账收入、主营支出、流量消耗、平台抽成。
  - 总统计不包含：`交易关闭`，但需单独统计展示。
  - 输出“纯收益（仅已到账）”与“纯收益（含待到账）”。
- 阶段2补充分润结算口径（累计法）：
  - `累计可分润净额 C(T)`：截止结算时点 `T` 的全历史“已到账收入 - 实际支出（含主营支出、流量消耗、平台抽成、主营退款支出）”。
  - `累计已分润额 S(T)`：采用最近一次有效分润批次的累计已分润值作为基准。
  - `本次可分润额 P(T) = C(T) - S(T)`。
  - 当 `P(T) <= 0` 时，本次不发放分润，负值作为待冲销余额结转到下次。
- 阶段1页面仅要求：导入页 + 符合条件明细页。
- 阶段2页面再补：统计页与分润页面。

## 能力范围

### 新增能力
- `statement-ingestion`: 导入支付宝账单与简化账单，解析为统一交易模型并保留账单所属账号（阶段1）。
- `business-transaction-classification`: 按已确认规则进行主营/成本/关闭/内部互转分类（阶段1）。
- `profit-ledger-reporting`: 按时间区间输出可对账的收入、支出、关闭和纯收益指标。
- `profit-sharing-settlement`: 基于累计法计算本次可分润额并记录分润批次，支持负值结转与历史追溯。

### 修改能力
- 无。

## 影响范围

- 受影响代码：
  - `apps/web`（阶段1：导入、明细；阶段2：统计、分润）
  - `apps/api`（阶段1：导入解析、规则筛选、入库；阶段2：聚合与分润接口）
  - `packages/shared`（交易模型、分类常量、统计口径函数）
- 依赖变更：
  - CSV 解析库（支持 GB18030）
  - 数据库存储（SQLite + Prisma）
  - 图标库（现代化图标，如 `lucide-react`）
- 数据影响：
  - 阶段1：新增交易表、导入批次表。
  - 阶段2：新增统计快照/聚合查询、分润批次表与分润累计快照字段（`C(T)`, `S(T)`, `P(T)`、结转余额）。
  - 旧数据无迁移要求，首版从导入批次开始建立账本。
